/*!
 * stravafeeds v0.1.0 - Strava Feed JS
 * https://github.com/chriskinch/strava-feeds
 */
!function(a,b){"object"==typeof exports?module.exports=b():"function"==typeof define&&define.amd?define("stravafeeds",[],b):a.stravafeeds=b()}(this,function(){function a(){}function b(a,b){this.element=a,this.settings=b,this.status=null}function c(a,b){this.element=a,this.settings=b,this.status=null}function d(){this.status=null}function e(a,b){for(var c in a)if(a.hasOwnProperty(c)&&(cont=b(c,a[c]),cont===!1))break}function f(){for(var a=1;a<arguments.length;a++)for(var b in arguments[a])arguments[a].hasOwnProperty(b)&&(arguments[0][b]=arguments[a][b]);return arguments[0]}function g(a){var b="";for(var c in a)""!==b&&(b+="&"),b+=c+"="+a[c];return b}var h={};return a.prototype={init:function(a,c,d,e,g){var i={};i.selector=a,i.element=document.querySelector(a);var j={per_page:1};i.settings=f({},j,g),i.config={url:"http://www.strava.com/api"+e,params:{access_token:d,per_page:i.settings.per_page,callback:"?"}};var k=new CustomEvent("stravafeeds:init");window.dispatchEvent(k);var l=new b(i.element,i.settings);l.loadFeed(i.config.url,i.config.params),h[a]=i},destroy:function(a){void 0===a&&(a=Object.keys(h)),e(a,function(a,b){var c=h[b],d=document.querySelectorAll(b);if(void 0!==c){var e=new CustomEvent("stravafeeds:destroy");window.dispatchEvent(e),d[0].innerHTML=null,delete h[b]}})},refresh:function(a){var c=this;void 0===a&&(a=Object.keys(h)),e(a,function(a,d){var e=h[d],f=document.querySelectorAll(d);if(void 0!==e){var g=new CustomEvent("stravafeeds:refresh");window.dispatchEvent(g);var i=new b(f,e.settings);i.loadFeed(e.config.url,e.config.params),c.destroy([d]),h[d]=e}})},update:function(a,b){var c=h[a],d=c.settings;c.settings=f({},d,b);var e=new CustomEvent("stravafeeds:update");window.dispatchEvent(e),this.refresh([a])},feeds:function(){return h}},b.prototype={loadFeed:function(a,b){var d=this,e=new CustomEvent("stravafeeds:getjson");window.dispatchEvent(e);var f=g(b);$.getJSON(a,f,function(a){console.log(a);var b=new c(d.element,d.settings);b.render(a[0])})}},c.prototype={render:function(a){var b,c,f,g=this,h=document.createDocumentFragment(),i=document.createElement("ul");f=g.buildDOMElement("div",{className:"strava-title",innerHTML:a.name}),h.appendChild(f),h.appendChild(i);var j=g.convertUnit(a.average_speed,"meterssec-mileshr",1),k=g.convertUnit(a.max_speed,"meterssec-mileshr",1),l=g.secToTime(a.moving_time),m=g.convertUnit(a.distance,"meters-miles",1),n=g.convertUnit(a.total_elevation_gain,"meters-feet",0),o=[];o.push(g.buildDOMElement("li",{className:"strava-average_speed",innerHTML:j})),o.push(g.buildDOMElement("li",{className:"strava-max_speed",innerHTML:k})),o.push(g.buildDOMElement("li",{className:"strava-moving_time",innerHTML:l})),o.push(g.buildDOMElement("li",{className:"strava-distance",innerHTML:m})),o.push(g.buildDOMElement("li",{className:"strava-elevation",innerHTML:n})),o.push(g.buildDOMElement("li",{className:"strava-calories",innerHTML:a.kilojoules})),c=g.buildDOMElement("div",{className:"strava-map"}),h.appendChild(c),e(o,function(a,b){i.appendChild(b)});var p=new CustomEvent("stravafeeds:attachelement");window.dispatchEvent(p),this.element.appendChild(h),b=new d,c=b.init(a)},buildDOMElement:function(a,b,c){if(c!==!1){var d=document.createElement(a);return e(b,function(a,b){d[a]=b}),d}},convertUnit:function(a,b,c){var d=null;switch(b){case"meterssec-mileshr":d=2.236936;break;case"meters-miles":d=.0006213711922;break;case"meters-feet":d=3.280839895;break;default:console.log("Conversion not defined!")}var e=a*d;return e.toFixed(c)},secToTime:function(a){var b=~~(a/3600),c=~~(a%3600/60),d=a%60;return ret="",b>0&&(ret+=""+b+":"+(10>c?"0":"")),ret+=""+c+":"+(10>d?"0":""),ret+=""+d,ret}},d.prototype={init:function(a){var b=this,c=(a.map,new google.maps.LatLngBounds),d=new google.maps.LatLng(a.start_latlng[0],a.start_latlng[1]),f=new google.maps.LatLng(a.end_latlng[0],a.end_latlng[1]);c.extend(d),c.extend(f);var g=400,h={height:g,width:g},i=new google.maps.Map(document.querySelector(".strava-map"),{zoom:b.getBoundsZoomLevel(c,h),center:c.getCenter(),disableDefaultUI:!0,zoomControl:!1,scrollwheel:!1}),j=google.maps.geometry.encoding.decodePath(a.map.summary_polyline);poly=new google.maps.Polyline({strokeColor:"#fc4c02",strokeOpacity:.75,strokeWeight:5}),poly.setMap(i);var k;k=poly.getPath(),k.push(d),e(j,function(a,b){k=poly.getPath(),k.push(b)}),k=poly.getPath(),k.push(f),new google.maps.Marker({position:d,title:"start",map:i}),new google.maps.Marker({position:f,title:"end",map:i});var l=new CustomEvent("stravafeeds:attachmap");return window.dispatchEvent(l),i},getBoundsZoomLevel:function(a,b){function c(a){var b=Math.sin(a*Math.PI/180),c=Math.log((1+b)/(1-b))/2;return Math.max(Math.min(c,Math.PI),-Math.PI)/2}function d(a,b,c){return Math.floor(Math.log(a/b/c)/Math.LN2)}var e={height:256,width:256},f=21,g=a.getNorthEast(),h=a.getSouthWest(),i=(c(g.lat())-c(h.lat()))/Math.PI,j=g.lng()-h.lng(),k=(0>j?j+360:j)/360,l=d(b.height,e.height,i),m=d(b.width,e.width,k);return Math.min(l,m,f)}},String.prototype.cleanup=function(){return this.toLowerCase().replace(/[^a-zA-Z0-9]+/g,"-")},Array.prototype.clean=function(a){for(var b=0;b<this.length;b++)this[b]===a&&(this.splice(b,1),b--);return this},"function"!=typeof window.CustomEvent&&!function(){function a(a,b){b=b||{bubbles:!1,cancelable:!1,detail:void 0};var c=document.createEvent("CustomEvent");return c.initCustomEvent(a,b.bubbles,b.cancelable,b.detail),c}window.CustomEvent=a,a.prototype=window.CustomEvent.prototype}(),new a});